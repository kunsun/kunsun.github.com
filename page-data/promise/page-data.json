{"componentChunkName":"component---src-templates-blog-post-js","path":"/promise","result":{"data":{"markdownRemark":{"html":"<p>Promise构造函数返回一个promise对象实例，这个返回的promise具有then方法。then方法中，调用者可以定义两个参数，分别是onfulfilled和onrejected，他们都是函数类型。\n其中onfulfilled通过参数可以获取promise对象的resolved的值；onrejected获得promise对象rejected的值。通过这个值，我们来处理异步完成后的逻辑。\n通过这个值，处理异步完成后的逻辑。</p>\n<h2>第一步</h2>\n<p>建立结构</p>\n<pre class=\"grvsc-container material-theme\" data-language=\"javascript\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">executor</span><span class=\"mtk1\">) { </span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk4\">prototype</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">onfulfilled</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">onrejected</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span></code></pre>\n<h2>第二步</h2>\n<p>完善基本框架</p>\n<pre class=\"grvsc-container material-theme\" data-language=\"js\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">executor</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk11\">self</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">this</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">value</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk4\">self</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">value</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">value</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk4\">self</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">reason</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk3\">executor</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk4\">prototype</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">onfulfilled</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Function</span><span class=\"mtk1\">.</span><span class=\"mtk4\">prototype</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">onrejected</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Function</span><span class=\"mtk1\">.</span><span class=\"mtk4\">prototype</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk3\">onfulfilled</span><span class=\"mtk1\">(</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk3\">onrejected</span><span class=\"mtk1\">(</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span></code></pre>\n<h2>第三步</h2>\n<p>加入异步逻辑：在合适的时候再执行resolve</p>\n<pre class=\"grvsc-container material-theme\" data-language=\"js\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">executor</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onFulfilledFunc</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Function</span><span class=\"mtk1\">.</span><span class=\"mtk4\">prototype</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onRejectedFunc</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Function</span><span class=\"mtk1\">.</span><span class=\"mtk4\">prototype</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\">// 自己的resolve函数，由调用者触发</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4 mtki\">value</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk10\">instanceof</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">value</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk8\">setTimeout</span><span class=\"mtk1\">(() </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">value</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;fulfilled&#39;</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk3\">onFulfilledFunc</span><span class=\"mtk1\">(</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\">// 自己的reject函数，由调用者触发</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reject</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4 mtki\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk8\">setTimeout</span><span class=\"mtk1\">(() </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">reason</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;rejected&#39;</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk3\">onRejectedFunc</span><span class=\"mtk1\">(</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\">// 调用时执行，参数是自己定义的reject与resolve</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk5 mtki\">// 立即执行</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk3\">executor</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk4\">prototype</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">onfulfilled</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">onreject</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">onfulfilled</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">typeof</span><span class=\"mtk1\"> </span><span class=\"mtk4\">onfulfilled</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;function&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk10\">?</span><span class=\"mtk1\"> </span><span class=\"mtk4\">onfulfilled</span><span class=\"mtk1\"> </span><span class=\"mtk10\">:</span><span class=\"mtk1\"> </span><span class=\"mtk4 mtki\">data</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">data</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk4\">onrejected</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">typeof</span><span class=\"mtk1\"> </span><span class=\"mtk4\">onrejected</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;function&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk10\">?</span><span class=\"mtk1\"> </span><span class=\"mtk4\">onrejected</span><span class=\"mtk1\"> </span><span class=\"mtk10\">:</span><span class=\"mtk1\"> </span><span class=\"mtk4 mtki\">error</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span><span class=\"mtk10\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk4\">error</span><span class=\"mtk1\">};</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;fulfilled&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk3\">onfulfilled</span><span class=\"mtk1\">(</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;rejected&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk3\">onrejected</span><span class=\"mtk1\">(</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onFulfilledFunc</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">onfulfilled</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onRejectedFunc</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">onrejected</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk5 mtki\">// 调用Promise，executor</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">promise</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk8\">setTimeout</span><span class=\"mtk1\">(() </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;data&#39;</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }, </span><span class=\"mtk7\">2000</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  })</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk4\">promise</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">data</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">console</span><span class=\"mtk1\">.</span><span class=\"mtk3\">log</span><span class=\"mtk1\">(</span><span class=\"mtk4\">data</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">console</span><span class=\"mtk1\">.</span><span class=\"mtk3\">log</span><span class=\"mtk1\">(</span><span class=\"mtk7\">1</span><span class=\"mtk1\">)</span></span></code></pre>\n<h2>第四步：加入任务队列逻辑</h2>\n<p>使用setTimeout模拟</p>\n<h2>第五步：细节优化</h2>\n<ol>\n<li>抛出错误</li>\n<li>\n<p>将onFulfilledFunc存入数组</p>\n<pre class=\"grvsc-container material-theme\" data-language=\"javascript\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">executor</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onRejectedArr</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [];</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onFulfilledArr</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [];</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> (</span><span class=\"mtk4 mtki\">value</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk10\">instanceof</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">value</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk8\">setTimeout</span><span class=\"mtk1\">(() </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">value</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;fulfilled&#39;</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onFulfilledArr</span><span class=\"mtk1\">.</span><span class=\"mtk3\">forEach</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">func</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk3\">func</span><span class=\"mtk1\">(</span><span class=\"mtk4\">value</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">}</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reject</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> (</span><span class=\"mtk4 mtki\">reason</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk8\">setTimeout</span><span class=\"mtk1\">(() </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">reason</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;rejected&#39;</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onRejectedArr</span><span class=\"mtk1\">.</span><span class=\"mtk3\">forEach</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">func</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk3\">func</span><span class=\"mtk1\">(</span><span class=\"mtk4\">reason</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">}</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk3\">executor</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">} </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">}</span></span></code></pre>\n</li>\n</ol>\n<p>  }</p>\n<p>  Promise.prototype.then = function(onfulfilled, onrejected) {\nonfulfilled = typeof onfulfilled === 'function' ? onfulfilled : (data) => data;\nonrejected = typeof onrejected === 'function' ? onrejected : (error) => {throw error};\nif (this.status === 'fulfilled') {\nonfulfilled(this.value);\n}</p>\n<pre class=\"grvsc-container material-theme\" data-language=\"\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\">if (this.status === &#39;rejected&#39;) {</span>\n<span class=\"grvsc-line\">  onrejected(this.value);</span>\n<span class=\"grvsc-line\">}</span>\n<span class=\"grvsc-line\">if (this.status === &#39;pending&#39;) {</span>\n<span class=\"grvsc-line\">  this.onFulfilledArr.push(onfulfilled);</span>\n<span class=\"grvsc-line\">  this.onRejectedArr.push(onrejected);    </span>\n<span class=\"grvsc-line\">}</span></code></pre>\n<p>  }</p>\n<pre class=\"grvsc-container material-theme\" data-language=\"\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\">## 第六步：链式调用</span>\n<span class=\"grvsc-line\">一个Promise实例的then方法体onfulfilled函数和onrejected函数中，是支持再次返回一个Promise实例的，也支持返回非Promise的普通值。</span>\n<span class=\"grvsc-line\">修改Promise.prototype.then:</span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\">```js</span>\n<span class=\"grvsc-line\">  Promise.prototype.then = function(onfulfilled, onrejected) {</span>\n<span class=\"grvsc-line\">    onfulfilled = typeof onfulfilled === &#39;function&#39; ? onfulfilled : data =&gt; data;</span>\n<span class=\"grvsc-line\">    onrejected = typeof onrejected === &#39;function&#39; ? onrejected : error =&gt; {throw error};</span>\n<span class=\"grvsc-line\">    let promise2;</span>\n<span class=\"grvsc-line\">    if (this.status === &#39;fulfilled&#39;) {</span>\n<span class=\"grvsc-line\">      return promise2 = new Promise((resolve, reject) =&gt; {</span>\n<span class=\"grvsc-line\">        setTimeout(() =&gt; {</span>\n<span class=\"grvsc-line\">          try {</span>\n<span class=\"grvsc-line\">            let result = onfulfilled(this.value)</span>\n<span class=\"grvsc-line\">            resolve(result)</span>\n<span class=\"grvsc-line\">          } catch(e) {</span>\n<span class=\"grvsc-line\">            reject(e)</span>\n<span class=\"grvsc-line\">          }</span>\n<span class=\"grvsc-line\">        })</span>\n<span class=\"grvsc-line\">      })</span>\n<span class=\"grvsc-line\">    }</span>\n<span class=\"grvsc-line\">    if (this.status === &#39;rejected&#39;) {</span>\n<span class=\"grvsc-line\">      return promise2 = new Promise((resolve, reject) =&gt; {</span>\n<span class=\"grvsc-line\">        setTimeout(() =&gt; {</span>\n<span class=\"grvsc-line\">          try {</span>\n<span class=\"grvsc-line\">            let result = onrejected(this.reason);</span>\n<span class=\"grvsc-line\">            reject(result);</span>\n<span class=\"grvsc-line\">          } catch(e) {</span>\n<span class=\"grvsc-line\">            reject(e);</span>\n<span class=\"grvsc-line\">          }</span>\n<span class=\"grvsc-line\">        })</span>\n<span class=\"grvsc-line\">      })</span>\n<span class=\"grvsc-line\">    }</span>\n<span class=\"grvsc-line\">    if (this.status === &#39;pending&#39;) {</span>\n<span class=\"grvsc-line\">      return promise2 = new Promise((resolve, reject) =&gt; {</span>\n<span class=\"grvsc-line\">        this.onFulfilledArray.push(() =&gt; {</span>\n<span class=\"grvsc-line\">          setTimeout(() =&gt; {</span>\n<span class=\"grvsc-line\">            try {</span>\n<span class=\"grvsc-line\">              let result = onfulfilled(this.value);</span>\n<span class=\"grvsc-line\">              resolve(result)</span>\n<span class=\"grvsc-line\">            } catch(e) {</span>\n<span class=\"grvsc-line\">              reject(e)</span>\n<span class=\"grvsc-line\">            }</span>\n<span class=\"grvsc-line\">          })</span>\n<span class=\"grvsc-line\">        })</span>\n<span class=\"grvsc-line\">        this.onRejectedArr.push(() =&gt; {</span>\n<span class=\"grvsc-line\">          setTimeout(() =&gt; {</span>\n<span class=\"grvsc-line\">            try {</span>\n<span class=\"grvsc-line\">              let result = onrejected(this.reason);</span>\n<span class=\"grvsc-line\">              resolve(result)</span>\n<span class=\"grvsc-line\">            } catch(e) {</span>\n<span class=\"grvsc-line\">              reject(e)</span>\n<span class=\"grvsc-line\">            }</span>\n<span class=\"grvsc-line\">          })</span>\n<span class=\"grvsc-line\">        });</span>\n<span class=\"grvsc-line\">      })</span>\n<span class=\"grvsc-line\">    }</span>\n<span class=\"grvsc-line\">  }</span></code></pre>\n<h2>第七步：完善链式调用</h2>\n<p>这里的逻辑有些复杂</p>\n<h2>第八步：Promise穿透实现</h2>\n<p>如果then传入的onfulfilled与onrejected不为函数，则使用默认值</p>\n<pre class=\"grvsc-container material-theme\" data-language=\"javascript\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk11\">promise</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk8\">setTimeout</span><span class=\"mtk1\">(() </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;kunsun&#39;</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }, </span><span class=\"mtk7\">2000</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk4\">promise</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  .</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk7\">null</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  .</span><span class=\"mtk3\">then</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">data</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk11\">console</span><span class=\"mtk1\">.</span><span class=\"mtk3\">log</span><span class=\"mtk1\">(</span><span class=\"mtk4\">data</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  })</span></span></code></pre>\n<h2>第九步：Promise静态方法与其他方法实现</h2>\n<h3>Promise.prototype.catch</h3>\n<pre class=\"grvsc-container material-theme\" data-language=\"js\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk4\">prototype</span><span class=\"mtk1\">.</span><span class=\"mtk3\">catch</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">catchFunc</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk7\">null</span><span class=\"mtk1\">, </span><span class=\"mtk4\">catchFunc</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span></code></pre>\n<h3>Promise.resolve</h3>\n<pre class=\"grvsc-container material-theme\" data-language=\"js\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk3\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">value</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk4\">value</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span></code></pre>\n<h3>Promise.reject</h3>\n<pre class=\"grvsc-container material-theme\" data-language=\"js\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk3\">reject</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">value</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">value</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span></code></pre>\n<h3>Promise.all</h3>\n<blockquote>\n<p>Promise.all(iterable) 方法返回一个Promise实例，此实例在iterable参数内所有的promise都完成时才resolve。如果参数中promise有一个失败（rejected）,此实例失败，失败原因是第一个失败promise的结果。</p>\n</blockquote>\n<pre class=\"grvsc-container material-theme\" data-language=\"javascript\" data-index=\"10\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk3\">all</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">promiseArr</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk8\">!</span><span class=\"mtk11\">Array</span><span class=\"mtk1\">.</span><span class=\"mtk3\">isArray</span><span class=\"mtk1\">(</span><span class=\"mtk4\">promiseArr</span><span class=\"mtk1\">)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk10\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;参数不是数组&#39;</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">resolveArr</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> [];</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk11\">length</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">promiseArr</span><span class=\"mtk1\">.</span><span class=\"mtk4\">length</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk10\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">i</span><span class=\"mtk8\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk4\">i</span><span class=\"mtk8\">&lt;</span><span class=\"mtk4\">length</span><span class=\"mtk1\">; </span><span class=\"mtk4\">i</span><span class=\"mtk8\">++</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          </span><span class=\"mtk4\">promiseArr</span><span class=\"mtk1\">[</span><span class=\"mtk4\">i</span><span class=\"mtk1\">].</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">data</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">            </span><span class=\"mtk4\">resolveArr</span><span class=\"mtk1\">.</span><span class=\"mtk3\">push</span><span class=\"mtk1\">(</span><span class=\"mtk4\">data</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">            </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">resolveArr</span><span class=\"mtk1\">.</span><span class=\"mtk4\">length</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk4\">length</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">              </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolveArr</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">            }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          }, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      } </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span></code></pre>\n<h3>Promise.race</h3>\n<blockquote>\n<p>当iterable参数里任何一个成功或失败，直接返回</p>\n</blockquote>\n<pre class=\"grvsc-container material-theme\" data-language=\"js\" data-index=\"11\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk3\">race</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">promiseArr</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk8\">!</span><span class=\"mtk11\">Array</span><span class=\"mtk1\">.</span><span class=\"mtk3\">isArray</span><span class=\"mtk1\">(</span><span class=\"mtk4\">promiseArr</span><span class=\"mtk1\">)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk10\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Error</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;参数不是数组&#39;</span><span class=\"mtk1\">);</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk11\">length</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">primiseArr</span><span class=\"mtk1\">.</span><span class=\"mtk4\">length</span><span class=\"mtk1\">;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk10\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">i</span><span class=\"mtk8\">=</span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk4\">i</span><span class=\"mtk8\">&lt;</span><span class=\"mtk4\">length</span><span class=\"mtk1\">; </span><span class=\"mtk4\">i</span><span class=\"mtk8\">++</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          </span><span class=\"mtk4\">promiseArray</span><span class=\"mtk1\">[</span><span class=\"mtk4\">i</span><span class=\"mtk1\">].</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      } </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span></code></pre>\n<h2>最终代码</h2>\n<pre class=\"grvsc-container material-theme\" data-language=\"javascript\" data-index=\"12\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk10\">function</span><span class=\"mtk1\"> </span><span class=\"mtk3\">Promise</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">executor</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onFulfilledArray</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onRejectedArray</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4 mtki\">value</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk10\">instanceof</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">value</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk8\">setTimeout</span><span class=\"mtk1\">(() </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">value</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;fulfilled&#39;</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onFulfilledArray</span><span class=\"mtk1\">.</span><span class=\"mtk3\">forEach</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">func</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          </span><span class=\"mtk3\">func</span><span class=\"mtk1\">(</span><span class=\"mtk4\">value</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reject</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4 mtki\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    </span><span class=\"mtk8\">setTimeout</span><span class=\"mtk1\">(() </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">reason</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;rejected&#39;</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onRejectedArray</span><span class=\"mtk1\">.</span><span class=\"mtk3\">forEach</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">func</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">          </span><span class=\"mtk3\">func</span><span class=\"mtk1\">(</span><span class=\"mtk4\">reason</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">        })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">      }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">    })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">  </span><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk3\">executor</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       } </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk3\">resolvePromise</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> (</span><span class=\"mtk4 mtki\">promise2</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">result</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk5 mtki\">// 当 result 和 promise2 相等时，也就是说 onfulfilled 返回 promise2 时，进行 reject</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">result</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk4\">promise2</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TypeError</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;error due to circular reference&#39;</span><span class=\"mtk1\">))</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk5 mtki\">// 是否已经执行过 onfulfilled 或者 onrejected</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">consumed</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">false</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">thenable</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">result</span><span class=\"mtk1\"> </span><span class=\"mtk10\">instanceof</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">result</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk4\">result</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">data</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk3\">resolvePromise</span><span class=\"mtk1\">(</span><span class=\"mtk4\">promise2</span><span class=\"mtk1\">, </span><span class=\"mtk4\">data</span><span class=\"mtk1\">, </span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         }, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       } </span><span class=\"mtk10\">else</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk4\">result</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">return</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk3\">isComplexResult</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4 mtki\">target</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">typeof</span><span class=\"mtk1\"> </span><span class=\"mtk4\">target</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;function&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk8\">||</span><span class=\"mtk1\"> </span><span class=\"mtk10\">typeof</span><span class=\"mtk1\"> </span><span class=\"mtk4\">target</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;object&#39;</span><span class=\"mtk1\">) </span><span class=\"mtk8\">&&</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">target</span><span class=\"mtk1\"> </span><span class=\"mtk8\">!==</span><span class=\"mtk1\"> </span><span class=\"mtk7\">null</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk5 mtki\">// 如果返回的是疑似 Promise 类型</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk3\">isComplexResult</span><span class=\"mtk1\">(</span><span class=\"mtk4\">result</span><span class=\"mtk1\">)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk4\">thenable</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">result</span><span class=\"mtk1\">.</span><span class=\"mtk4\">then</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk5 mtki\">// 如果返回的是 Promise 类型，具有 then 方法</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">typeof</span><span class=\"mtk1\"> </span><span class=\"mtk4\">thenable</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;function&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk4\">thenable</span><span class=\"mtk1\">.</span><span class=\"mtk3\">call</span><span class=\"mtk1\">(</span><span class=\"mtk4\">result</span><span class=\"mtk1\">, </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">data</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">consumed</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">               </span><span class=\"mtk10\">return</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk4\">consumed</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">true</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk3\">resolvePromise</span><span class=\"mtk1\">(</span><span class=\"mtk4\">promise2</span><span class=\"mtk1\">, </span><span class=\"mtk4\">data</span><span class=\"mtk1\">, </span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           }, </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">error</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">consumed</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">               </span><span class=\"mtk10\">return</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk4\">consumed</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">true</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">error</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">else</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk4\">result</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       } </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">consumed</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk10\">return</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk4\">consumed</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">true</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">else</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk4\">result</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk4\">prototype</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">onfulfilled</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">onrejected</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk4\">onfulfilled</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">typeof</span><span class=\"mtk1\"> </span><span class=\"mtk4\">onfulfilled</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;function&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk10\">?</span><span class=\"mtk1\"> </span><span class=\"mtk4\">onfulfilled</span><span class=\"mtk1\"> </span><span class=\"mtk10\">:</span><span class=\"mtk1\"> </span><span class=\"mtk4 mtki\">data</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">data</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk4\">onrejected</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">typeof</span><span class=\"mtk1\"> </span><span class=\"mtk4\">onrejected</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;function&#39;</span><span class=\"mtk1\"> </span><span class=\"mtk10\">?</span><span class=\"mtk1\"> </span><span class=\"mtk4\">onrejected</span><span class=\"mtk1\"> </span><span class=\"mtk10\">:</span><span class=\"mtk1\"> </span><span class=\"mtk4 mtki\">error</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span><span class=\"mtk10\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk4\">error</span><span class=\"mtk1\">}</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk5 mtki\">// promise2 将作为 then 方法的返回值</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">promise2</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;fulfilled&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">promise2</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk8\">setTimeout</span><span class=\"mtk1\">(() </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk5 mtki\">// 这个新的 promise2 resolved 的值为 onfulfilled 的执行结果</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">result</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">onfulfilled</span><span class=\"mtk1\">(</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">value</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk3\">resolvePromise</span><span class=\"mtk1\">(</span><span class=\"mtk4\">promise2</span><span class=\"mtk1\">, </span><span class=\"mtk4\">result</span><span class=\"mtk1\">, </span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;rejected&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">promise2</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk8\">setTimeout</span><span class=\"mtk1\">(() </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk5 mtki\">// 这个新的 promise2 reject 的值为 onrejected 的执行结果</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">            </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">result</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">onrejected</span><span class=\"mtk1\">(</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">reason</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">            </span><span class=\"mtk3\">resolvePromise</span><span class=\"mtk1\">(</span><span class=\"mtk4\">promise2</span><span class=\"mtk1\">, </span><span class=\"mtk4\">result</span><span class=\"mtk1\">, </span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">status</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&#39;pending&#39;</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">promise2</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onFulfilledArray</span><span class=\"mtk1\">.</span><span class=\"mtk3\">push</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">value</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">result</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">onfulfilled</span><span class=\"mtk1\">(</span><span class=\"mtk4\">value</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk3\">resolvePromise</span><span class=\"mtk1\">(</span><span class=\"mtk4\">promise2</span><span class=\"mtk1\">, </span><span class=\"mtk4\">result</span><span class=\"mtk1\">, </span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         })</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk4\">onRejectedArray</span><span class=\"mtk1\">.</span><span class=\"mtk3\">push</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">reason</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">result</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk3\">onrejected</span><span class=\"mtk1\">(</span><span class=\"mtk4\">reason</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk3\">resolvePromise</span><span class=\"mtk1\">(</span><span class=\"mtk4\">promise2</span><span class=\"mtk1\">, </span><span class=\"mtk4\">result</span><span class=\"mtk1\">, </span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         })      </span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk4\">prototype</span><span class=\"mtk1\">.</span><span class=\"mtk3\">catch</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">catchFunc</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">this</span><span class=\"mtk1\">.</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk7\">null</span><span class=\"mtk1\">, </span><span class=\"mtk4\">catchFunc</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk3\">resolve</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">value</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk4\">value</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk3\">reject</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">value</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">value</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk3\">race</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">promiseArray</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk8\">!</span><span class=\"mtk11\">Array</span><span class=\"mtk1\">.</span><span class=\"mtk3\">isArray</span><span class=\"mtk1\">(</span><span class=\"mtk4\">promiseArray</span><span class=\"mtk1\">)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TypeError</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;The arguments should be an array!&#39;</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk11\">length</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">promiseArray</span><span class=\"mtk1\">.</span><span class=\"mtk4\">length</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">i</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk4\">i</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&lt;</span><span class=\"mtk4\">length</span><span class=\"mtk1\">; </span><span class=\"mtk4\">i</span><span class=\"mtk8\">++</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk4\">promiseArray</span><span class=\"mtk1\">[</span><span class=\"mtk4\">i</span><span class=\"mtk1\">].</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   }</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk3\">all</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk10\">function</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">promiseArray</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk8\">!</span><span class=\"mtk11\">Array</span><span class=\"mtk1\">.</span><span class=\"mtk3\">isArray</span><span class=\"mtk1\">(</span><span class=\"mtk4\">promiseArray</span><span class=\"mtk1\">)) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">throw</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">TypeError</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&#39;The arguments should be an array!&#39;</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     </span><span class=\"mtk10\">return</span><span class=\"mtk1\"> </span><span class=\"mtk10\">new</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Promise</span><span class=\"mtk1\">((</span><span class=\"mtk4 mtki\">resolve</span><span class=\"mtk1\">, </span><span class=\"mtk4 mtki\">reject</span><span class=\"mtk1\">) </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">try</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">resultArray</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> []</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">const</span><span class=\"mtk1\"> </span><span class=\"mtk11\">length</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">promiseArray</span><span class=\"mtk1\">.</span><span class=\"mtk4\">length</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk10\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk10\">let</span><span class=\"mtk1\"> </span><span class=\"mtk4\">i</span><span class=\"mtk1\"> </span><span class=\"mtk8\">=</span><span class=\"mtk1\"> </span><span class=\"mtk7\">0</span><span class=\"mtk1\">; </span><span class=\"mtk4\">i</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&lt;</span><span class=\"mtk4\">length</span><span class=\"mtk1\">; </span><span class=\"mtk4\">i</span><span class=\"mtk8\">++</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           </span><span class=\"mtk4\">promiseArray</span><span class=\"mtk1\">[</span><span class=\"mtk4\">i</span><span class=\"mtk1\">].</span><span class=\"mtk3\">then</span><span class=\"mtk1\">(</span><span class=\"mtk4 mtki\">data</span><span class=\"mtk1\"> </span><span class=\"mtk10\">=&gt;</span><span class=\"mtk1\"> {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk4\">resultArray</span><span class=\"mtk1\">.</span><span class=\"mtk3\">push</span><span class=\"mtk1\">(</span><span class=\"mtk4\">data</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             </span><span class=\"mtk10\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk4\">resultArray</span><span class=\"mtk1\">.</span><span class=\"mtk4\">length</span><span class=\"mtk1\"> </span><span class=\"mtk8\">===</span><span class=\"mtk1\"> </span><span class=\"mtk4\">length</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">               </span><span class=\"mtk3\">resolve</span><span class=\"mtk1\">(</span><span class=\"mtk4\">resultArray</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">             }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">           }, </span><span class=\"mtk4\">reject</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       </span><span class=\"mtk10\">catch</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">) {</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">         </span><span class=\"mtk3\">reject</span><span class=\"mtk1\">(</span><span class=\"mtk4\">e</span><span class=\"mtk1\">)</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">       }</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">     })</span></span>\n<span class=\"grvsc-line\"><span class=\"mtk1\">   }</span></span></code></pre>\n<h2>总结</h2>\n<ol>\n<li>Promise可以保持某个pending一段时间</li>\n<li>Promise需要处理错误</li>\n<li>Promise实例添加多个then</li>\n<li>链式调用</li>\n<li>Promise穿透</li>\n<li>静态方法</li>\n</ol>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n  }\n  \n  .grvsc-code {\n    display: inline-block;\n    min-width: 100%;\n  }\n  \n  .grvsc-line {\n    display: inline-block;\n    box-sizing: border-box;\n    width: 100%;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-line-highlighted {\n    background-color: var(--grvsc-line-highlighted-background-color, transparent);\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, transparent);\n  }\n  \n  .material-theme {\n    background-color: #282c34;\n    color: #abb2bf;\n  }\n  .material-theme .mtki { font-style: italic; }\n  .material-theme .mtk1 { color: #ABB2BF; }\n  .material-theme .mtk10 { color: #C678DD; }\n  .material-theme .mtk3 { color: #61AFEF; }\n  .material-theme .mtk4 { color: #E06C75; }\n  .material-theme .mtk11 { color: #E5C07B; }\n  .material-theme .mtk8 { color: #56B6C2; }\n  .material-theme .mtk6 { color: #98C379; }\n  .material-theme .mtk7 { color: #D19A66; }\n  .material-theme .mtk5 { color: #7F848E; }\n</style>","frontmatter":{"date":"February 02, 2021","path":"/promise","title":"Promise"}}},"pageContext":{}},"staticQueryHashes":[]}